<!DOCTYPE html><html lang="id"><head><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Kasir Laundry -- Mobile (v2 Premium)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&amp;display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#f6f8fb; --card:#ffffff; --primary:#246bfd; --muted:#6b7280; --radius:14px; --success:#2ea44f; --danger:#ef4444; }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
    body{background:var(--bg);color:#0f172a;-webkit-font-smoothing:antialiased}
    .app{max-width:460px;margin:0 auto;min-height:100vh;position:relative;padding-bottom:84px}
    header.appbar{position:sticky;top:0;background:linear-gradient(90deg,var(--primary),#5f8dff);color:#fff;padding:14px 16px;font-weight:700;display:flex;align-items:center;gap:12px;z-index:40;border-bottom-left-radius:16px;border-bottom-right-radius:16px}
    header.appbar .title{font-size:1.05rem}
    .container{padding:18px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:0 6px 20px rgba(12,30,60,0.06);padding:14px;margin-bottom:12px}
    label{display:block;font-size:0.92rem;color:var(--muted);margin-bottom:6px}
    input[type=text],input[type=number],input[type=password],input[type=date],select,textarea{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #e6eef8;background:#fbfdff;font-size:0.98rem}
    input:focus,select:focus,textarea:focus{outline:2px solid rgba(36,107,253,0.12);border-color:var(--primary)}
    button.btn{display:inline-block;background:var(--primary);color:#fff;border:none;padding:12px 14px;border-radius:12px;font-weight:700;width:100%;font-size:1rem;cursor:pointer;box-shadow:0 8px 30px rgba(36,107,253,0.12)}
    button.ghost{background:transparent;border:1px solid #e6eef8;color:var(--muted);box-shadow:none}
    .list-item{display:flex;justify-content:space-between;gap:12px;padding:12px;border-radius:12px;background:#fbfdff;border:1px solid #f1f5f9}
    .chip{display:inline-block;padding:6px 10px;border-radius:999px;background:linear-gradient(90deg,var(--primary),#5f8dff);color:#fff;font-weight:600;font-size:0.85rem}
    .meta{font-size:0.88rem;color:var(--muted)}
    .bottom-nav{position:fixed;left:0;right:0;bottom:0;height:68px;background:#fff;border-top:1px solid #eef2f7;display:flex;justify-content:center;align-items:center;padding:8px 12px;gap:12px;z-index:50}
    .bottom-nav .nav{max-width:460px;width:100%;display:flex;justify-content:space-between;gap:8px}
    .nav button{flex:1;background:transparent;border:none;padding:8px 10px;border-radius:12px;font-size:0.9rem;color:var(--muted);display:flex;flex-direction:column;align-items:center;gap:4px}
    .nav button.active{background:linear-gradient(90deg,rgba(36,107,253,0.12),rgba(95,141,255,0.08));color:var(--primary);}
    .action-sticky{position:fixed;left:50%;transform:translateX(-50%);bottom:82px;width:92%;max-width:440px}
    #splash{position:fixed;inset:0;background:linear-gradient(135deg,var(--primary),#5f8dff);display:flex;align-items:center;justify-content:center;z-index:9999;color:#fff;flex-direction:column}
    #splash img{width:82px;height:82px;margin-bottom:12px}
    @media(min-width:540px){body{background:linear-gradient(180deg,#f6f8fb,#f7fbff)}}
    .row{display:flex;gap:8px}
    .muted{color:var(--muted)}
    .tiny{font-size:0.82rem}
    .right{margin-left:auto}
    .danger{color:var(--danger)}
    .actions{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end;margin-top:6px}
    button.small{padding:8px 10px;font-size:0.85rem;width:auto;border-radius:10px}
    button.ghost.danger{border-color:#ffe3e3;color:var(--danger);background:#fffafa}
    #adminPremiumQuick button.ghost {display: none;}
    .tablelist{width:100%;border-collapse:collapse}
    .tablelist th, .tablelist td{padding:6px 8px;font-size:0.92rem}
    .tablelist th{background:#f3f6fb;font-weight:700;text-align:left;}
    .tablelist td{background:#fff;}
    .tablelist tr:nth-child(even) td{background:#f8fafc}
    .inputrow{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .inputrow label{margin-bottom:0}
    .inputrow input{margin-bottom:0}
    .inputrow select{margin-bottom:0}
    .inputrow button{margin-bottom:0}
    @media (max-width: 540px) {
      .container { padding: 8px }
      .card { padding: 10px }
      .inputrow input, .inputrow select { padding: 8px 8px; font-size:0.92rem }
    }
  </style>
</head>
<body>
  <div id="splash">
    <img src="https://img.icons8.com/fluency/96/laundry.png" alt="logo">
    <div style="font-weight:700;font-size:1.15rem" id="splashTitle">Kasir Laundry</div>
  </div>

  <div class="app" id="app">
    <header class="appbar">
      <div style="width:36px;height:36px;border-radius:9px;background:rgba(255,255,255,0.12);display:flex;align-items:center;justify-content:center">üß∫</div>
      <div class="title">Kasir Laundry -- Mobile</div>
      <div style="margin-left:auto;font-size:0.9rem" id="premiumBadge"></div>
    </header>

    <div class="container">
      <!-- Halaman BERANDA -->
      <div id="page_home">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:700">Halo, Admin</div>
              <div class="muted tiny">Siap melayani pelanggan</div>
            </div>
            <div style="text-align:right">
              <div class="muted tiny">Usaha</div>
              <div id="usahaName" style="font-weight:700">Kasir Laundry</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
            <input id="search" type="text" placeholder="Cari nama / no HP / layanan" style="flex:1;padding:10px 12px;border-radius:10px;border:1px solid #edf3ff">
            <button class="ghost" onclick="showPage('layanan')">Baru</button>
          </div>
          <div id="recentList"></div>
        </div>

        <div class="card">
          <div style="display:flex;gap:8px">
            <button class="btn" onclick="showPage('layanan')">üßæ Buat Transaksi</button>
            <button class="ghost" onclick="showPage('admin')">‚öôÔ∏è Admin</button>
          </div>
        </div>
      </div>

      <!-- Halaman TRANSAKSI / LAYANAN -->
      <div id="page_layanan" style="display:none">
        <div class="card">
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px">
            <div style="font-weight:700">Tambah Transaksi</div>
            <div class="muted tiny right">#ID <span id="previewId">-</span></div>
          </div>
          <label>Pilih Pelanggan</label>
          <div class="row" style="align-items:center;gap:6px">
            <select id="selectPelanggan" style="flex:1"></select>
            <button class="ghost small" onclick="showPage('pelanggan')">Tambah/Edit</button>
          </div>
          <label>No HP Pelanggan</label>
          <input id="nohp" type="text" placeholder="0812xxxx">
          <label>Alamat Pelanggan</label>
          <input id="alamatPelanggan" type="text" placeholder="Alamat pelanggan">

          <div class="row">
            <div style="flex:1">
              <label>Kategori</label>
              <select id="kategori" onchange="renderLayanan()">
                <option value="utama">Utama / Reguler (kg)</option>
                <option value="ekspres">Ekspres (kg)</option>
              </select>
            </div>
            <div style="width:110px">
              <label>Berat (kg)</label>
              <input id="berat" type="number" min="1" value="1">
            </div>
          </div>

          <label>Layanan</label>
          <select id="layanan"></select>

          <label>Layanan Tambahan</label>
          <div id="tambahanArea"></div>

          <label>Pilih Karyawan</label>
          <div class="row" style="align-items:center;gap:6px">
            <select id="selectKaryawan" style="flex:1"></select>
            <button class="ghost small" onclick="showPage('karyawan')">Tambah/Edit</button>
          </div>

          <div class="row" style="margin-top:8px">
            <div style="flex:1">
              <label>Tgl Masuk</label>
              <input id="tglMasuk" type="date">
            </div>
            <div style="width:140px">
              <label>Tgl Selesai</label>
              <input id="tglSelesai" type="date">
            </div>
          </div>

          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
            <div style="font-weight:700">Total</div>
            <div id="total" style="font-weight:800;color:var(--primary)">Rp0</div>
          </div>
        </div>
        <div style="height:12px"></div>
        <div id="riwayatSection"></div>
      </div>

      <!-- Halaman DATA PELANGGAN -->
      <div id="page_pelanggan" style="display:none">
        <div class="card">
          <div style="font-weight:700;margin-bottom:8px">Data Pelanggan</div>
          <div class="inputrow">
            <input id="plg_nama" type="text" placeholder="Nama pelanggan">
            <input id="plg_nohp" type="text" placeholder="No HP">
            <input id="plg_alamat" type="text" placeholder="Alamat">
            <button class="btn" style="width:80px" onclick="tambahPelanggan()">Tambah</button>
          </div>
          <table class="tablelist" id="listPelanggan"></table>
        </div>
        <button class="ghost" onclick="showPage('layanan')">‚¨Ö Kembali</button>
      </div>

      <!-- Halaman DATA KARYAWAN -->
      <div id="page_karyawan" style="display:none">
        <div class="card">
          <div style="font-weight:700;margin-bottom:8px">Data Karyawan</div>
          <div class="inputrow">
            <input id="kry_nama" type="text" placeholder="Nama karyawan">
            <input id="kry_nohp" type="text" placeholder="No HP">
            <input id="kry_jabatan" type="text" placeholder="Jabatan">
            <button class="btn" style="width:80px" onclick="tambahKaryawan()">Tambah</button>
          </div>
          <table class="tablelist" id="listKaryawan"></table>
        </div>
        <button class="ghost" onclick="showPage('layanan')">‚¨Ö Kembali</button>
      </div>

      <!-- Halaman ADMIN -->
      <div id="page_admin" style="display:none">
        <div class="card">
          <div style="display:flex;gap:8px;align-items:center">
            <div style="font-weight:700">Admin Panel</div>
            <div class="muted tiny right">v2</div>
          </div>
          <div style="margin-top:10px">
            <button class="btn" onclick="showPage('layananAdmin')">Kelola Layanan</button>
            <div style="height:8px"></div>
            <button class="ghost" onclick="showPage('pelanggan')">Data Pelanggan</button>
            <div style="height:8px"></div>
            <button class="ghost" onclick="showPage('karyawan')">Data Karyawan</button>
            <div style="height:8px"></div>
            <button class="ghost" onclick="showPage('premium')">Premium &amp; Usaha</button>
            <div style="height:8px"></div>
            <button class="ghost" onclick="exportData()">Backup (JSON)</button>
            <div style="height:8px"></div>
            <input type="file" id="restoreFileV2" onchange="restoreV2(event)">
            <div style="height:8px"></div>
            <button class="ghost" onclick="migrateFromOld()">Import dari versi lama (pilihan)</button>
            <div style="height:10px"></div>
            <div class="card" id="adminPremiumQuick">
              <div style="display:flex;flex-direction:column;gap:8px">
                <div style="font-weight:700">Aktivasi Premium (Cepat)</div>
                <div class="muted tiny">Masukkan kode 10 digit untuk mengaktifkan premium pada perangkat ini langsung dari panel Admin.</div>
                <label style="margin-top:6px">Kode Premium (10 digit)</label>
                <input id="kodePremiumAdmin" maxlength="10" type="text" placeholder="Masukkan kode">
                <div style="display:flex;gap:8px">
                  <button class="btn" onclick="aktivasiPremiumFromAdmin()">Aktivasi</button>
                  <button class="ghost" onclick="navTo('premium')">Buka Pengaturan Premium</button>
                </div>
                <div style="display:flex;gap:8px;margin-top:6px">
                  <button class="ghost" onclick="exportData()">Backup/Export JSON</button>
                </div>
                <div id="adminPremiumStatus" class="muted tiny" style="margin-top:6px"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="card">
          <label>Password Admin</label>
          <input id="adminPassV2" type="password" placeholder="Password admin">
          <div style="height:8px"></div>
          <button class="btn" onclick="loginAdminV2()">Masuk</button>
        </div>
      </div>

      <!-- Halaman KELola LAYANAN -->
      <div id="page_layananAdmin" style="display:none">
        <div class="card">
          <div style="display:flex;gap:8px">
            <input id="nmLayananU" type="text" placeholder="Nama layanan utama">
            <input id="hrgLayananU" type="number" placeholder="Harga/kg">
            <button class="btn" style="width:80px" onclick="addLayanan('utama')">Tambah</button>
          </div>
          <div id="listUtama" style="margin-top:12px"></div>
        </div>
        <div class="card">
          <div style="display:flex;gap:8px">
            <input id="nmLayananE" type="text" placeholder="Nama layanan ekspres">
            <input id="hrgLayananE" type="number" placeholder="Harga/kg">
            <button class="btn" style="width:80px" onclick="addLayanan('ekspres')">Tambah</button>
          </div>
          <div id="listEkspres" style="margin-top:12px"></div>
        </div>
        <div class="card">
          <div style="display:flex;gap:8px">
            <input id="nmLayananT" type="text" placeholder="Nama layanan tambahan">
            <input id="hrgLayananT" type="number" placeholder="Harga/item">
            <button class="btn" style="width:80px" onclick="addLayanan('tambahan')">Tambah</button>
          </div>
          <div id="listTambahan" style="margin-top:12px"></div>
        </div>
        <div style="height:12px"></div>
        <button class="ghost" onclick="showPage('admin')">‚¨Ö Kembali</button>
      </div>

      <!-- Halaman PREMIUM (default) -->
      <div id="page_premium" style="display:none">
        <div class="card">
          <label>Kode Premium (10 digit)</label>
          <input id="kodePremiumV2" maxlength="10" type="text" placeholder="Masukkan kode 10 digit">
          <div style="height:8px"></div>
          <button class="btn" onclick="aktivasiPremiumV2()">Aktivasi Premium</button>
        </div>
        <div id="premiumSettingsV2" style="display:none">
          <div class="card">
            <label>Nama Usaha</label>
            <input id="usahaNamaV2" type="text">
            <label>No HP Usaha</label>
            <input id="usahaNoV2" type="text">
            <label>Alamat Usaha</label>
            <textarea id="usahaAlamatV2"></textarea>
            <label>Upload QRIS</label>
            <input type="file" id="qrisV2" accept="image/*" onchange="uploadQrisV2(event)">
            <div id="previewQrisV2" style="margin-top:8px"></div>
            <div style="height:8px"></div>
            <button class="btn" onclick="saveUsahaV2()">Simpan Data Usaha</button>
          </div>
        </div>
      </div>
    </div>
    <div class="action-sticky" id="stickyAction" style="display:none">
      <button class="btn" id="saveTrxBtn" onclick="saveTransaction()">Simpan Transaksi</button>
    </div>
    <div class="bottom-nav">
      <div class="nav">
        <button id="nav_home" class="active" onclick="navTo('home')">üè†<span style="font-size:0.73rem">Beranda</span></button>
        <button id="nav_layanan" onclick="navTo('layanan')">üßæ<span style="font-size:0.73rem">Transaksi</span></button>
        <button id="nav_admin" onclick="navTo('admin')">‚öôÔ∏è<span style="font-size:0.73rem">Admin</span></button>
      </div>
    </div>
  </div>

<script>
/* --- Storage Keys --- */
const KEY = {
  transaksi: 'transaksiKasir_v2',
  layananUtama: 'layananUtamaKasir_v2',
  layananEkspres: 'layananEkspresKasir_v2',
  layananTambahan: 'layananTambahanKasir_v2',
  usaha: 'usahaDataKasir_v2',
  premium: 'premiumKasir_v2',
  adminPass: 'adminPassKasir_v2',
  usedCodes: 'premiumUsedCodes_v2',
  pelanggan: 'pelangganKasir_v2',
  karyawan: 'karyawanKasir_v2'
};
// ... VALID_PREMIUM_CODES copy dari kode Anda (potong untuk ringkas) ...
const VALID_PREMIUM_CODES = [
"1000761069",
"1017214880",
"1017219311",
"1022371887",
"1023788759",
"1030882956",
"1039419541",
"1039567697",
"1042691424",
"1044061341",
"1045147378",
"1045259010",
"1053159901",
"1059719530",
"1062469342",
"1077942059",
"1081933774",
"1144188423",
"1165418138",
"1169020652",
"1169283108",
"1169927387",
"1172921781",
"1176561992",
"1177583039",
"1185449297",
"1186642688",
"1190013772",
"1200085585",
"1207284952",
"1209944912",
"1228869768",
"1230429267",
"1239584187",
"1247181102",
"1248031727",
"1256874038",
"1290720207",
"1291297197",
"1312018267",
"1331857684",
"1333697262",
"1341259746",
"1368054746",
"1380120137",
"1386373915",
"1393509079",
"1407471360",
"1407917102",
"1420609710",
"1429119898",
"1431396384",
"1431641676",
"1444013155",
"1447004816",
"1454065595",
"1457064685",
"1462898476",
"1467086655",
"1469363439",
"1481222081",
"1481560644",
"1485665680",
"1495414774",
"1495887090",
"1514561127",
"1520892149",
"1525767365",
"1532680026",
"1543198573",
"1553689446",
"1565045075",
"1597867390",
"1599101142",
"1625906954",
"1629749619",
"1641262922",
"1659842902",
"1672906160",
"1684711713",
"1685994080",
"1690476836",
"1693951844",
"1704279116",
"1711882656",
"1725432120",
"1745773018",
"1749003493",
"1752789539",
"1762151604",
"1764717453",
"1769496740",
"1773643325",
"1776395944",
"1793198229",
"1793594845",
"1794824730",
"1809649627",
"1814929326",
"1822869356",
"1827423995",
"1836024101",
"1838114170",
"1852866077",
"1855824732",
"1862761764",
"1862915799",
"1899508318",
"1901854736",
"1923813596",
"1935065018",
"1938654775",
"1947936548",
"1950675677",
"1954517571",
"1969956040",
"1982222693",
"1987033387",
"1988536599",
"1991039695",
"1993652952",
"2008578308",
"2009589331",
"2017039349",
"2021646714",
"2028971351",
"2036504202",
"2048497721",
"2049491453",
"2054420921",
"2073203511",
"2075343432",
"2120820119",
"2130845044",
"2135295308",
"2159646067",
"2168027707",
"2175122665",
"2194265383",
"2199630397",
"2245208810",
"2259287362",
"2259957191",
"2265390960",
"2268195522",
"2286890522",
"2287427874",
"2296416040",
"2306035148",
"2307187728",
"2310876606",
"2310890111",
"2320430569",
"2323624118",
"2334657134",
"2339821763",
"2349604219",
"2350388165",
"2350968937",
"2363444509",
"2379989538",
"2398545239",
"2409600090",
"2433327403",
"2437806781",
"2440366600",
"2445898046",
"2450763560",
"2455301981",
"2470426425",
"2487114453",
"2499017005",
"2500980105",
"2517260879",
"2526324117",
"2533748224",
"2540449627",
"2545710786",
"2557164201",
"2557220556",
"2565998029",
"2588864203",
"2589656097",
"2595061200",
"2608957854",
"2611710554",
"2624990126",
"2625390343",
"2646684703",
"2648453130",
"2656741826",
"2663189323",
"2663814329",
"2665449484",
"2672127630",
"2676972022",
"2682427877",
"2690080432",
"2691498974",
"2699603430",
"2705391347",
"2713935242",
"2719760766",
"2730620069",
"2733587701",
"2733999552",
"2738840875",
"2741713529",
"2743279461",
"2745192698",
"2775119300",
"2789132527",
"2801526115",
"2815174002",
"2850484019",
"2853963938",
"2871156337",
"2880274822",
"2885003926",
"2885836712",
"2888861859",
"2912931868",
"2918977326",
"2941741218",
"2968030641",
"3005132761",
"3005825335",
"3007275697",
"3014474214",
"3029125673",
"3032360164",
"3033892378",
"3048783700",
"3054535036",
"3062557725",
"3064668586",
"3078507934",
"3081411058",
"3095107645",
"3097366500",
"3108163853",
"3109403597",
"3110517700",
"3122332366",
"3122847381",
"3123614721",
"3133135742",
"3145484304",
"3148152149",
"3154431876",
"3159495419",
"3171668198",
"3173354283",
"3182594330",
"3197565510",
"3202546027",
"3205861679",
"3213613330",
"3224815281",
"3226650984",
"3238275364",
"3258812268",
"3272337372",
"3273062535",
"3275853564",
"3279449679",
"3292763964",
"3293193400",
"3293763434",
"3301329261",
"3326586121",
"3340977043",
"3348265804",
"3353005732",
"3354331881",
"3395280380",
"3404347769",
"3412920598",
"3427405761",
"3434465706",
"3454926534",
"3465401542",
"3470388472",
"3473564482",
"3483723921",
"3522237599",
"3536154345",
"3540636389",
"3540880553",
"3550630299",
"3565426990",
"3567425978",
"3577909908",
"3593337643",
"3607457615",
"3618079358",
"3625285971",
"3625690082",
"3631004089",
"3632303299",
"3636361962",
"3640983817",
"3641742921",
"3674594529",
"3678691562",
"3682323132",
"3683920941",
"3684561031",
"3684797323",
"3685144132",
"3686992262",
"3690469467",
"3715897454",
"3727493237",
"3734060551",
"3739211729",
"3750480236",
"3769831917",
"3816350197",
"3858187147",
"3865740594",
"3879327508",
"3929215373",
"3947452326",
"3957005682",
"3969798998",
"3986151890",
"3995575314",
"4003914189",
"4014240181",
"4015588978",
"4017988041",
"4018236892",
"4027348749",
"4029703513",
"4034903251",
"4040103797",
"4045629269",
"4053425053",
"4059083003",
"4063827335",
"4073152552",
"4086913213",
"4086977666",
"4091605168",
"4098586295",
"4117366664",
"4126506358",
"4147079811",
"4147467012",
"4148810377",
"4151957845",
"4165280717",
"4176014672",
"4176431138",
"4190385055",
"4220623080",
"4222571711",
"4225339399",
"4226639769",
"4234551132",
"4249607357",
"4264542370",
"4264955891",
"4270866144",
"4271581677",
"4287009537",
"4287727562",
"4289095640",
"4295502684",
"4317956647",
"4330071865",
"4330999105",
"4354364841",
"4359586103",
"4360957469",
"4367642480",
"4393459903",
"4399438339",
"4408041623",
"4419173038",
"4419822858",
"4438626649",
"4446610560",
"4447635231",
"4454423281",
"4455200407",
"4456337371",
"4473289978",
"4475245502",
"4489332143",
"4512157016",
"4514235008",
"4527015179",
"4535838555",
"4546674575",
"4558092094",
"4568725172",
"4579533233",
"4603878692",
"4605608641",
"4609308940",
"4610520348",
"4617135569",
"4630748590",
"4630789121",
"4656188709",
"4661820795",
"4662542084",
"4662873001",
"4670529502",
"4672032134",
"4675577902",
"4678531118",
"4684525962",
"4695611941",
"4709588487",
"4715491074",
"4721199051",
"4722742503",
"4734310008",
"4740704946",
"4745732027",
"4792610911",
"4801707115",
"4805821538",
"4807585522",
"4814802977",
"4834907048",
"4835954122",
"4851652675",
"4854404582",
"4857405727",
"4857992688",
"4862377769",
"4872692752",
"4899085539",
"4900402055",
"4907977992",
"4932117209",
"4950428219",
"4952933718",
"4953738178",
"4964252061",
"4965402824",
"4973182585",
"4976607456",
"4983902786",
"4991159318",
"4996333557",
"5000436348",
"5020979123",
"5053467669",
"5053900455",
"5061621314",
"5065588361",
"5071123792",
"5090115662",
"5091425470",
"5103680055",
"5113694786",
"5123009460",
"5134366469",
"5148192904",
"5150371627",
"5159997204",
"5161114744",
"5167253972",
"5179337645",
"5180745161",
"5192989973",
"5243921907",
"5246473625",
"5247985676",
"5254227367",
"5260292116",
"5272851680",
"5274276188",
"5277698104",
"5279984381",
"5282063749",
"5293351847",
"5293497619",
"5294667583",
"5299279508",
"5301678291",
"5303175242",
"5312013175",
"5320484994",
"5335637477",
"5337003392",
"5344323900",
"5364848402",
"5375602356",
"5381349326",
"5385827755",
"5387666354",
"5402271956",
"5426821165",
"5440738824",
"5455005314",
"5474104933",
"5501975385",
"5502626726",
"5504262871",
"5516569666",
"5548275086",
"5555508923",
"5555602739",
"5569504198",
"5585596763",
"5605156942",
"5605594930",
"5606480874",
"5623496422",
"5624807809",
"5632298892",
"5639075693",
"5641823231",
"5654155151",
"5658031525",
"5671023803",
"5675027819",
"5677516467",
"5678478514",
"5685297040",
"5687075857",
"5703889488",
"5709652496",
"5709794154",
"5711532225",
"5743177823",
"5746883711",
"5747300863",
"5754662930",
"5768544299",
"5770251533",
"5778594918",
"5780104124",
"5783137661",
"5783472829",
"5793569481",
"5795929223",
"5797466618",
"5798762360",
"5809389306",
"5821357669",
"5823536039",
"5824024670",
"5833829417",
"5851311817",
"5867287819",
"5875480945",
"5877885153",
"5882003420",
"5883724674",
"5889042709",
"5906246747",
"5907001928",
"5918522625",
"5924709810",
"5938394041",
"5944857363",
"5954221827",
"5955365294",
"5990170896",
"6002053512",
"6007749556",
"6030996515",
"6037111575",
"6052086186",
"6053515157",
"6057039430",
"6059012922",
"6061793294",
"6066989643",
"6070042584",
"6075545733",
"6075656400",
"6077906855",
"6085437820",
"6088169218",
"6108910233",
"6112143603",
"6131164464",
"6140713863",
"6157280240",
"6162462791",
"6170283227",
"6172914748",
"6192090522",
"6200371036",
"6207933742",
"6216617776",
"6223593650",
"6229027156",
"6234349286",
"6241318417",
"6241705475",
"6244467543",
"6253026058",
"6259719806",
"6271374102",
"6279991319",
"6283196521",
"6291907764",
"6299956923",
"6303333154",
"6303417086",
"6308306099",
"6322925754",
"6332346211",
"6344094790",
"6372333964",
"6378501650",
"6386178051",
"6387071531",
"6395182633",
"6402623586",
"6414337407",
"6417121445",
"6418780179",
"6419852060",
"6419911534",
"6424525993",
"6433547255",
"6440800009",
"6441062523",
"6452813289",
"6472628371",
"6490580852",
"6500154770",
"6521571311",
"6524674556",
"6532154507",
"6546474333",
"6589913867",
"6591880541",
"6605541508",
"6618398792",
"6634502551",
"6654729782",
"6664048431",
"6671227725",
"6704369133",
"6707115489",
"6715549450",
"6735252609",
"6762450528",
"6770471192",
"6771887457",
"6786646987",
"6788236937",
"6789370103",
"6790550053",
"6794302953",
"6804206302",
"6825898833",
"6841574998",
"6860982107",
"6861560430",
"6893936979",
"6895543052",
"6899568001",
"6906668027",
"6945004700",
"6946286031",
"6962832002",
"6969362272",
"6976885605",
"6993746438",
"6995201425",
"7008968772",
"7011486838",
"7029760651",
"7033313504",
"7034281059",
"7045637957",
"7046007246",
"7047837611",
"7050882373",
"7050932770",
"7056479185",
"7058018588",
"7063911847",
"7075646568",
"7081465048",
"7084979308",
"7089387360",
"7100687234",
"7110528279",
"7130651001",
"7140407027",
"7153226119",
"7162965163",
"7182265941",
"7230748344",
"7231458282",
"7236366750",
"7248668674",
"7254494404",
"7262826335",
"7268238534",
"7277548443",
"7298498228",
"7331046408",
"7332315120",
"7333186402",
"7337323086",
"7344278028",
"7353753753",
"7369887746",
"7379400618",
"7381419441",
"7396647686",
"7399688332",
"7403623703",
"7405072031",
"7447597772",
"7449945029",
"7452182281",
"7465006768",
"7468001461",
"7468606489",
"7470131422",
"7484735692",
"7499373579",
"7502054136",
"7504642926",
"7510211266",
"7523237039",
"7528135743",
"7531460242",
"7533670491",
"7543993592",
"7544581404",
"7545733482",
"7557023102",
"7559999408",
"7562423179",
"7562855554",
"7568119284",
"7581114480",
"7582474592",
"7582741134",
"7586697875",
"7586831805",
"7587874735",
"7599003618",
"7601473820",
"7626083124",
"7637487858",
"7666119774",
"7682471756",
"7685315333",
"7688580926",
"7698185054",
"7720919034",
"7725179022",
"7726794659",
"7736062825",
"7737706094",
"7739900635",
"7739999814",
"7755512485",
"7756385966",
"7760497419",
"7761148341",
"7761455086",
"7772859341",
"7778378984",
"7798270486",
"7803744067",
"7812134165",
"7812226691",
"7816480684",
"7829725896",
"7835357737",
"7837623792",
"7842974820",
"7847313737",
"7848457410",
"7866174827",
"7882818376",
"7891976428",
"7914346280",
"7916571655",
"7930673350",
"7938550105",
"7940387689",
"7945542349",
"7949959691",
"7952431697",
"7967946095",
"7982209864",
"7990980363",
"7992569951",
"8042061651",
"8044430817",
"8069566690",
"8078955340",
"8079303822",
"8087061011",
"8094610507",
"8094673773",
"8115434705",
"8132496860",
"8133663141",
"8162489913",
"8182303379",
"8186952330",
"8194459821",
"8221535180",
"8225775273",
"8232668361",
"8238943701",
"8257685055",
"8265477219",
"8267805072",
"8279931586",
"8282183515",
"8297980940",
"8321283542",
"8325028981",
"8327883237",
"8343369421",
"8363488261",
"8391371361",
"8400897467",
"8431140247",
"8438302141",
"8456216860",
"8456283329",
"8458469562",
"8465144540",
"8467236610",
"8470326259",
"8471899175",
"8491436892",
"8494056756",
"8533769819",
"8536277721",
"8538268765",
"8540528024",
"8541002279",
"8552433520",
"8553334511",
"8556928499",
"8574931878",
"8604259805",
"8620304925",
"8633300444",
"8645340406",
"8662445405",
"8664997113",
"8676326903",
"8682705772",
"8708236951",
"8773576780",
"8779599200",
"8792530519",
"8795291867",
"8820408902",
"8820543815",
"8825814420",
"8826873545",
"8828353593",
"8836532247",
"8839347935",
"8848688104",
"8865710183",
"8870938530",
"8881695259",
"8888874667",
"8907134888",
"8907779996",
"8928925150",
"8954626206",
"8963214777",
"8964456516",
"8967920865",
"8975877285",
"8976283246",
"8987442324",
"9010056403",
"9020196434",
"9041973179",
"9058212719",
"9068042140",
"9070093388",
"9081095854",
"9092674755",
"9119402852",
"9123492640",
"9124586511",
"9136706765",
"9151010866",
"9157959514",
"9162957099",
"9163222022",
"9164235591",
"9164773901",
"9203272940",
"9207536478",
"9228276312",
"9240488829",
"9242004312",
"9249772906",
"9255722842",
"9260242953",
"9263453666",
"9267379156",
"9269092605",
"9269285251",
"9270350380",
"9273702605",
"9294457688",
"9303077828",
"9307906914",
"9313974401",
"9338001711",
"9342478746",
"9344909856",
"9345541817",
"9362924480",
"9364108397",
"9377310636",
"9379529533",
"9382928810",
"9399876267",
"9400300291",
"9453726729",
"9472966472",
"9475058016",
"9476757058",
"9478163366",
"9487746326",
"9490876649",
"9494391227",
"9514537352",
"9514924211",
"9518121274",
"9522005785",
"9538873074",
"9558688597",
"9565148484",
"9569006622",
"9589494907",
"9592164782",
"9606012000",
"9642257832",
"9644411774",
"9649525127",
"9666566686",
"9676940093",
"9682637618",
"9684107055",
"9684208504",
"9687669258",
"9688228770",
"9696962121",
"9711423741",
"9711683399",
"9715232453",
"9723672733",
"9727764340",
"9731876802",
"9732720922",
"9734442261",
"9737805681",
"9747163055",
"9752060270",
"9759839889",
"9765300699",
"9765629884",
"9775126889",
"9777246668",
"9786447266",
"9790112092",
"9804356825",
"9805320791",
"9828187868",
"9832058275",
"9844907108",
"9846092267",
"9869111742",
"9877861986",
"9878325225",
"9878808275",
"9883273823",
"9883782421",
"9889762257",
"9891918796",
"9916822734",
"9934773356",
"9966968701",
"9970642451",
"9983015255",
"9983373120",
"9993209270"
]; // dst

let transaksi = JSON.parse(localStorage.getItem(KEY.transaksi) || '[]');
let layananUtama = JSON.parse(localStorage.getItem(KEY.layananUtama) || '[]');
let layananEkspres = JSON.parse(localStorage.getItem(KEY.layananEkspres) || '[]');
let layananTambahan = JSON.parse(localStorage.getItem(KEY.layananTambahan) || '[]');
let usahaData = JSON.parse(localStorage.getItem(KEY.usaha) || JSON.stringify({nama:'Kasir Laundry',nohp:'',alamat:'',qris:''}));
let premium = localStorage.getItem(KEY.premium) === 'true';
let adminPass = localStorage.getItem(KEY.adminPass) || '1234';
let usedCodes = JSON.parse(localStorage.getItem(KEY.usedCodes) || '{}');
let pelangganList = JSON.parse(localStorage.getItem(KEY.pelanggan) || '[]');
let karyawanList = JSON.parse(localStorage.getItem(KEY.karyawan) || '[]');

function saveAllLocal(){
  localStorage.setItem(KEY.transaksi, JSON.stringify(transaksi));
  localStorage.setItem(KEY.layananUtama, JSON.stringify(layananUtama));
  localStorage.setItem(KEY.layananEkspres, JSON.stringify(layananEkspres));
  localStorage.setItem(KEY.layananTambahan, JSON.stringify(layananTambahan));
  localStorage.setItem(KEY.usaha, JSON.stringify(usahaData));
  localStorage.setItem(KEY.premium, premium ? 'true' : 'false');
  localStorage.setItem(KEY.usedCodes, JSON.stringify(usedCodes));
  localStorage.setItem(KEY.pelanggan, JSON.stringify(pelangganList));
  localStorage.setItem(KEY.karyawan, JSON.stringify(karyawanList));
}

/* --- INIT --- */
window.addEventListener('load', ()=>{
  setDeviceFingerprint();
  setDefaults();
  renderHome(); renderLayanan(); renderListAdmin(); updatePremiumBadge();
  renderListPelanggan(); renderListKaryawan();
  document.getElementById('search').addEventListener('input', ()=>{renderHome(document.getElementById('search').value)});
  setTimeout(()=>document.getElementById('splash').style.display='none',800);
});

/* --- DEFAULT DATA --- */
function setDefaults(){
  if(!layananUtama.length){ layananUtama = [{nama:'Cuci Kering',harga:7000},{nama:'Cuci + Setrika',harga:9000},{nama:'Setrika',harga:6000}]; }
  if(!layananEkspres.length){ layananEkspres = [{nama:'Cuci Ekspres',harga:14000},{nama:'Cuci + Setrika Ekspres',harga:17000}]; }
  if(!layananTambahan.length){ layananTambahan = [{nama:'Jas',harga:20000},{nama:'Hordeng',harga:15000},{nama:'Selimut',harga:15000}]; }
  saveAllLocal();
}

/* --- NAVIGATION --- */
function navTo(page){ 
  document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
  if(page==='home'){document.getElementById('nav_home').classList.add('active'); showPage('home');}
  if(page==='layanan'){document.getElementById('nav_layanan').classList.add('active'); showPage('layanan');}
  if(page==='admin'){document.getElementById('nav_admin').classList.add('active'); showPage('admin');}
}
function showPage(p){
  ['home','layanan','admin','layananAdmin','premium','pelanggan','karyawan'].forEach(id=>{ const el=document.getElementById('page_'+id); if(el) el.style.display='none'; });
  if(p==='home') document.getElementById('page_home').style.display='block';
  if(p==='layanan') document.getElementById('page_layanan').style.display='block';
  if(p==='admin') document.getElementById('page_admin').style.display='block';
  if(p==='layananAdmin') document.getElementById('page_layananAdmin').style.display='block';
  if(p==='premium') document.getElementById('page_premium').style.display='block';
  if(p==='pelanggan'){document.getElementById('page_pelanggan').style.display='block';renderListPelanggan();}
  if(p==='karyawan'){document.getElementById('page_karyawan').style.display='block';renderListKaryawan();}
  document.getElementById('stickyAction').style.display = (p==='layanan') ? 'block' : 'none';
  if(p==='layanan'){renderSelectPelanggan();renderSelectKaryawan();}
}

/* --- PELANGGAN --- */
function tambahPelanggan(){
  let nama = document.getElementById('plg_nama').value.trim(),
      nohp = document.getElementById('plg_nohp').value.trim(),
      alamat = document.getElementById('plg_alamat').value.trim();
  if(!nama||!nohp) return alert('Nama dan No HP wajib!');
  if(pelangganList.some(p=>p.nohp===nohp)) return alert('No HP sudah terdaftar!');
  pelangganList.push({nama,nohp,alamat});
  saveAllLocal();
  renderListPelanggan();
  document.getElementById('plg_nama').value='';document.getElementById('plg_nohp').value='';document.getElementById('plg_alamat').value='';
  renderSelectPelanggan();
}
function renderListPelanggan(){
  let t='<tr><th>Nama</th><th>No HP</th><th>Alamat</th><th></th></tr>';
  pelangganList.forEach((p,i)=>{
    t+=`<tr>
      <td>${p.nama}</td>
      <td>${p.nohp}</td>
      <td>${p.alamat||''}</td>
      <td>
        <button class="ghost small" onclick="hapusPelanggan(${i})">Hapus</button>
      </td>
    </tr>`;
  });
  document.getElementById('listPelanggan').innerHTML = t;
}
function hapusPelanggan(i){
  if(confirm('Hapus pelanggan?')){ pelangganList.splice(i,1); saveAllLocal(); renderListPelanggan(); renderSelectPelanggan(); }
}
function renderSelectPelanggan(){
  let sel=document.getElementById('selectPelanggan');
  sel.innerHTML = '<option value="">- Pilih Pelanggan -</option>';
  pelangganList.forEach((p,i)=>{
    sel.innerHTML += `<option value="${i}">${p.nama} (${p.nohp})</option>`;
  });
  sel.onchange = ()=>{
    let idx = sel.value;
    if(idx===''){ 
      document.getElementById('nohp').value='';
      document.getElementById('alamatPelanggan').value='';
      return;
    }
    document.getElementById('nohp').value = pelangganList[idx].nohp;
    document.getElementById('alamatPelanggan').value = pelangganList[idx].alamat||'';
  }
}

/* --- KARYAWAN --- */
function tambahKaryawan(){
  let nama = document.getElementById('kry_nama').value.trim(),
      nohp = document.getElementById('kry_nohp').value.trim(),
      jabatan = document.getElementById('kry_jabatan').value.trim();
  if(!nama) return alert('Nama wajib!');
  karyawanList.push({nama,nohp,jabatan});
  saveAllLocal();
  renderListKaryawan();
  document.getElementById('kry_nama').value='';document.getElementById('kry_nohp').value='';document.getElementById('kry_jabatan').value='';
  renderSelectKaryawan();
}
function renderListKaryawan(){
  let t='<tr><th>Nama</th><th>No HP</th><th>Jabatan</th><th></th></tr>';
  karyawanList.forEach((p,i)=>{
    t+=`<tr>
      <td>${p.nama}</td>
      <td>${p.nohp}</td>
      <td>${p.jabatan||''}</td>
      <td>
        <button class="ghost small" onclick="hapusKaryawan(${i})">Hapus</button>
      </td>
    </tr>`;
  });
  document.getElementById('listKaryawan').innerHTML = t;
}
function hapusKaryawan(i){
  if(confirm('Hapus karyawan?')){ karyawanList.splice(i,1); saveAllLocal(); renderListKaryawan(); renderSelectKaryawan(); }
}
function renderSelectKaryawan(){
  let sel=document.getElementById('selectKaryawan');
  sel.innerHTML = '<option value="">- Pilih Karyawan -</option>';
  karyawanList.forEach((p,i)=>{
    sel.innerHTML += `<option value="${i}">${p.nama} (${p.jabatan||''})</option>`;
  });
}

/* --- HOME & LIST TRANSAKSI --- */
function renderHome(filter=''){
  document.getElementById('usahaName').innerText = usahaData.nama || 'Kasir Laundry';
  const recent = transaksi.slice().reverse().filter(t=>{
    if(!filter) return true;
    const f = (filter||'').toLowerCase();
    return (t.nama||'').toLowerCase().includes(f) || (t.nohp||'').includes(f) || (t.layanan||'').toLowerCase().includes(f);
  });
  const recentDiv = document.getElementById('recentList'); recentDiv.innerHTML='';
  if(!recent.length){ recentDiv.innerHTML='<div class="muted tiny" style="text-align:center">Belum ada transaksi</div>'; return; }
  recent.slice(0,8).forEach(t=>{
    const el=document.createElement('div');
    el.className='list-item';
    const utama = (t.hargaUtama||0) * (t.berat||0);
    el.innerHTML = `
      <div>
        <div style="font-weight:700">${t.nama}</div>
        <div class="meta">${t.nohp} ‚Ä¢ ${t.layanan} ‚Ä¢ ${t.berat}kg</div>
      </div>
      <div style="text-align:right">
        <div class="chip">Rp${formatRupiah(t.total||0)}</div>
        <div class="muted tiny">${t.tglMasuk||''}</div>
        <div class="actions">
          <button class="ghost small" onclick="kirimWAme(${t.id},false)">WA</button>
          <button class="ghost small" onclick="kirimWAme(${t.id},true)">Laporan</button>
          <button class="ghost small danger" onclick="hapusTransaksi(${t.id})">Hapus</button>
        </div>
      </div>`;
    recentDiv.appendChild(el);
  });
}

/* --- TRANSAKSI --- */
function renderLayanan(){
  renderSelectPelanggan();renderSelectKaryawan();
  const sel=document.getElementById('layanan'); sel.innerHTML='';
  const kat=document.getElementById('kategori').value;
  const arr = kat==='utama' ? layananUtama : layananEkspres;
  arr.forEach((l,i)=> sel.innerHTML += `<option value="${i}">${l.nama} (Rp${formatRupiah(l.harga)}/kg)</option>`);
  const tambahanArea = document.getElementById('tambahanArea'); tambahanArea.innerHTML='';
  layananTambahan.forEach((l,i)=>{
    const id='chkT_'+i;
    tambahanArea.innerHTML += `
      <label style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
        <input type="checkbox" id="${id}">
        <div style="flex:1">${l.nama}</div>
        <div class="chip">Rp${formatRupiah(l.harga)}</div>
        <input type="number" id="qty_${i}" value="1" min="1" style="width:72px;border-radius:10px;padding:8px;border:1px solid #eef3ff;" disabled>
      </label>`;
  });
  layananTambahan.forEach((l,i)=>{
    setTimeout(()=>{
      const cb=document.getElementById('chkT_'+i);
      const qty=document.getElementById('qty_'+i);
      if(cb){
        cb.onchange=()=>{ qty.disabled=!cb.checked; calculateTotal(); };
        qty.oninput=calculateTotal;
      }
    },5);
  });
  document.getElementById('berat').oninput = calculateTotal;
  document.getElementById('layanan').onchange = calculateTotal;
  calculateTotal();
  renderRiwayatOnLayanan();
}

/* --- TOTAL --- */
function calculateTotal(){
  const kat=document.getElementById('kategori').value;
  const idx=document.getElementById('layanan').value;
  const berat=parseInt(document.getElementById('berat').value)||0;
  let total=0;
  const arr=kat==='utama' ? layananUtama : layananEkspres;
  if(arr[idx]) total += (arr[idx].harga||0) * berat;
  layananTambahan.forEach((l,i)=>{
    const cb=document.getElementById('chkT_'+i);
    const qty=document.getElementById('qty_'+i);
    if(cb && cb.checked){
      total += (l.harga||0) * (parseInt(qty.value)||1);
    }
  });
  document.getElementById('total').innerText = 'Rp'+formatRupiah(total);
  return total;
}

/* --- SIMPAN TRANSAKSI --- */
function saveTransaction(){
  let pelangganIdx = document.getElementById('selectPelanggan').value, pelanggan;
  if(pelangganIdx!==''){ pelanggan = pelangganList[pelangganIdx]; }
  const nama=pelanggan?pelanggan.nama:prompt('Nama pelanggan?')||'';
  const nohp=pelanggan?pelanggan.nohp:document.getElementById('nohp').value.trim();
  const alamat=pelanggan?pelanggan.alamat:document.getElementById('alamatPelanggan').value.trim();
  const kat=document.getElementById('kategori').value;
  const idx=document.getElementById('layanan').value;
  const berat=parseInt(document.getElementById('berat').value)||0;
  let karyawanIdx = document.getElementById('selectKaryawan').value, karyawan;
  if(karyawanIdx!==''){ karyawan = karyawanList[karyawanIdx]; }
  const karyawanNama = karyawan?karyawan.nama:'';
  const tglMasuk=document.getElementById('tglMasuk').value;
  if(!nama||!nohp||idx===''||berat<1||!tglMasuk) return alert('Lengkapi semua data wajib!');
  const arr = kat==='utama' ? layananUtama : layananEkspres;
  const layanan = arr[idx];
  const tambahan=[];
  layananTambahan.forEach((l,i)=>{
    const cb=document.getElementById('chkT_'+i);
    const qty=document.getElementById('qty_'+i);
    if(cb && cb.checked){
      tambahan.push({nama:l.nama,harga:l.harga,qty:parseInt(qty.value)||1});
    }
  });
  if(transaksi.some(t=>t.nohp===nohp && t.tglMasuk===tglMasuk)) return alert('Transaksi dengan no HP & tanggal masuk ini sudah ada!');
  const total=calculateTotal();
  const id=Date.now();
  const trx={id,nama,nohp,alamat,kategori:kat,layanan:layanan.nama,hargaUtama:layanan.harga,berat,tambahan,karyawan:karyawanNama,tglMasuk,tglSelesai:document.getElementById('tglSelesai').value,total};
  transaksi.push(trx);
  saveAllLocal();
  renderHome();
  renderRiwayatOnLayanan();
  alert('Transaksi tersimpan!');
  if(premium && usahaData.qris){ showQrisTemp(); }
  // Reset form
  document.getElementById('nohp').value='';
  document.getElementById('alamatPelanggan').value='';
  document.getElementById('tglMasuk').value='';
  document.getElementById('tglSelesai').value='';
  document.getElementById('berat').value='1';
  document.getElementById('selectPelanggan').value='';
  document.getElementById('selectKaryawan').value='';
  renderLayanan();
}

/* --- RIWAYAT DI HALAMAN TRANSAKSI --- */
function renderRiwayatOnLayanan(){
  const div=document.getElementById('riwayatSection'); div.innerHTML='';
  if(!transaksi.length){
    div.innerHTML='<div class="muted tiny" style="text-align:center">Belum ada transaksi</div>';
    return;
  }
  transaksi.slice().reverse().forEach(t=>{
    const el=document.createElement('div'); el.className='card';
    const utamaLine = `
      <div class="row tiny" style="justify-content:space-between;align-items:center;margin-top:6px">
        <div>Berat: ${t.berat} kg √ó Rp${formatRupiah(t.hargaUtama||0)} = <b>Rp${formatRupiah((t.hargaUtama||0)*(t.berat||0))}</b></div>
        <button class="ghost small tiny" onclick="decrementBerat(${t.id})">-1 kg</button>
      </div>`;
    let tambahanLines = '';
    if (t.tambahan && t.tambahan.length){
      tambahanLines = t.tambahan.map((x,i)=>`
        <div class="row tiny" style="justify-content:space-between;align-items:center;margin-top:4px">
          <div>${x.nama} √ó ${x.qty} √ó Rp${formatRupiah(x.harga||0)} = <b>Rp${formatRupiah((x.harga||0)*(x.qty||0))}</b></div>
          <button class="ghost small tiny" onclick="decrementTambahan(${t.id},${i})">-1</button>
        </div>`).join('');
    }
    el.innerHTML = `
      <div style="display:flex;justify-content:space-between">
        <div>
          <div style="font-weight:700">${t.nama}</div>
          <div class="meta">${t.nohp} ‚Ä¢ ${t.layanan} (${t.kategori})</div>
        </div>
        <div style="text-align:right">
          <div class="chip">Rp${formatRupiah(t.total||0)}</div>
        </div>
      </div>
      <div style="margin-top:8px" class="muted tiny">${t.tglMasuk||''}${t.tglSelesai? ' ‚Üí '+t.tglSelesai : ''}</div>
      ${utamaLine}
      ${tambahanLines}
      <div class="actions">
        <button class="ghost small" onclick="kirimWAme(${t.id},false)">Kirim WA</button>
        <button class="ghost small" onclick="kirimWAme(${t.id},true)">Laporan</button>
        <button class="ghost small danger" onclick="hapusTransaksi(${t.id})">Hapus</button>
      </div>
    `;
    div.appendChild(el);
  });
}

/* --- ADMIN / LAYANAN --- */
function addLayanan(type){
  if(type==='utama'){
    const n=document.getElementById('nmLayananU').value.trim();
    const h=parseInt(document.getElementById('hrgLayananU').value)||0;
    if(!n||h<=0) return alert('Isi data layanan utama!');
    layananUtama.push({nama:n,harga:h});
    document.getElementById('nmLayananU').value='';
    document.getElementById('hrgLayananU').value='';
  }
  if(type==='ekspres'){
    const n=document.getElementById('nmLayananE').value.trim();
    const h=parseInt(document.getElementById('hrgLayananE').value)||0;
    if(!n||h<=0) return alert('Isi data layanan ekspres!');
    layananEkspres.push({nama:n,harga:h});
    document.getElementById('nmLayananE').value='';
    document.getElementById('hrgLayananE').value='';
  }
  if(type==='tambahan'){
    const n=document.getElementById('nmLayananT').value.trim();
    const h=parseInt(document.getElementById('hrgLayananT').value)||0;
    if(!n||h<=0) return alert('Isi data layanan tambahan!');
    layananTambahan.push({nama:n,harga:h});
    document.getElementById('nmLayananT').value='';
    document.getElementById('hrgLayananT').value='';
  }
  saveAllLocal(); renderListAdmin(); renderLayanan();
}
function renderListAdmin(){
  const lu=document.getElementById('listUtama'); lu.innerHTML='';
  layananUtama.forEach((l,i)=>{
    const el=document.createElement('div');
    el.className='list-item';
    el.innerHTML=`<div>${l.nama}<div class="muted tiny">Rp${formatRupiah(l.harga)}/kg</div></div><div><button class="ghost" onclick="hapusLayanan('utama',${i})">Hapus</button></div>`;
    lu.appendChild(el);
  });
  const le=document.getElementById('listEkspres'); le.innerHTML='';
  layananEkspres.forEach((l,i)=>{
    const el=document.createElement('div');
    el.className='list-item';
    el.innerHTML=`<div>${l.nama}<div class="muted tiny">Rp${formatRupiah(l.harga)}/kg</div></div><div><button class="ghost" onclick="hapusLayanan('ekspres',${i})">Hapus</button></div>`;
    le.appendChild(el);
  });
  const lt=document.getElementById('listTambahan'); lt.innerHTML='';
  layananTambahan.forEach((l,i)=>{
    const el=document.createElement('div');
    el.className='list-item';
    el.innerHTML=`<div>${l.nama}<div class="muted tiny">Rp${formatRupiah(l.harga)}/item</div></div><div><button class="ghost" onclick="hapusLayanan('tambahan',${i})">Hapus</button></div>`;
    lt.appendChild(el);
  });
}
function hapusLayanan(type,i){
  if(!confirm('Hapus layanan ini?')) return;
  if(type==='utama') layananUtama.splice(i,1);
  if(type==='ekspres') layananEkspres.splice(i,1);
  if(type==='tambahan') layananTambahan.splice(i,1);
  saveAllLocal(); renderListAdmin(); renderLayanan();
}

/* --- PREMIUM --- */
function aktivasiPremiumV2(){
  const kode=document.getElementById('kodePremiumV2').value.trim();
  if(kode.length!==10) return alert('Kode harus 10 digit!');
  if(!VALID_PREMIUM_CODES.includes(kode)) return alert('Kode tidak valid!');
  const uid=deviceId(); usedCodes = JSON.parse(localStorage.getItem(KEY.usedCodes) || '{}');
  if(usedCodes[kode] && usedCodes[kode] !== uid) return alert('Kode sudah digunakan di perangkat lain (catatan: verifikasi lintas-perangkat memerlukan server).');
  usedCodes[kode] = uid; localStorage.setItem(KEY.usedCodes, JSON.stringify(usedCodes)); premium = true; localStorage.setItem(KEY.premium, 'true'); saveAllLocal(); updatePremiumBadge(); alert('Premium aktif pada perangkat ini!');
}
function aktivasiPremiumFromAdmin(){
  const kode = document.getElementById('kodePremiumAdmin').value.trim();
  if(!kode){ alert('Masukkan kode dulu'); return; }
  document.getElementById('kodePremiumV2').value = kode;
  aktivasiPremiumV2();
  document.getElementById('adminPremiumStatus').innerText = localStorage.getItem('premiumKasir_v2') === 'true' ? 'Premium aktif pada perangkat ini.' : 'Gagal aktivasi.';
}
function updatePremiumBadge(){
  document.getElementById('premiumBadge').innerText = premium ? '‚≠ê Premium' : '';
  document.getElementById('splashTitle').innerText = premium ? (usahaData.nama || 'Kasir Laundry') : 'Kasir Laundry';
  if(premium){
    document.getElementById('premiumSettingsV2').style.display='block';
    document.getElementById('usahaNamaV2').value = usahaData.nama || '';
    document.getElementById('usahaNoV2').value = usahaData.nohp || '';
    document.getElementById('usahaAlamatV2').value = usahaData.alamat || '';
    if(usahaData.qris) document.getElementById('previewQrisV2').innerHTML = `<img src="${usahaData.qris}" style="max-width:140px;border-radius:8px">`;
  }
}
function saveUsahaV2(){
  usahaData.nama=document.getElementById('usahaNamaV2').value;
  usahaData.nohp=document.getElementById('usahaNoV2').value;
  usahaData.alamat=document.getElementById('usahaAlamatV2').value;
  localStorage.setItem(KEY.usaha, JSON.stringify(usahaData));
  saveAllLocal(); alert('Data usaha disimpan!'); renderHome();
}
function uploadQrisV2(e){
  const file=e.target.files[0];
  const reader=new FileReader();
  reader.onload=ev=>{
    usahaData.qris = ev.target.result;
    localStorage.setItem(KEY.usaha, JSON.stringify(usahaData));
    document.getElementById('previewQrisV2').innerHTML = `<img src="${usahaData.qris}" style="max-width:140px;border-radius:8px">`;
    saveAllLocal();
  };
  reader.readAsDataURL(file);
}
function showQrisTemp(){
  const div=document.createElement('div');
  div.className='card';
  div.style.position='fixed';
  div.style.left='50%';
  div.style.top='40%';
  div.style.transform='translateX(-50%)';
  div.style.zIndex=1200;
  div.innerHTML=`<div style="text-align:center"><h3>Scan QRIS untuk bayar</h3><img src="${usahaData.qris}" style="max-width:220px"></div>`;
  document.body.appendChild(div);
  setTimeout(()=>div.remove(),9000);
}

/* --- BACKUP/RESTORE/MIGRATE --- */
function exportData(){
  const blob=new Blob([JSON.stringify({transaksi,layananUtama,layananEkspres,layananTambahan,usahaData,premium,usedCodes,pelangganList,karyawanList})],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='backup_kasir_v2_with_premium.json'; a.click();
}
function restoreV2(e){
  const f=e.target.files[0];
  const r=new FileReader();
  r.onload=ev=>{
    try{
      const data=JSON.parse(ev.target.result);
      transaksi = data.transaksi||transaksi;
      layananUtama = data.layananUtama||layananUtama;
      layananEkspres = data.layananEkspres||layananEkspres;
      layananTambahan = data.layananTambahan||layananTambahan;
      usahaData = data.usahaData||usahaData;
      premium = data.premium||premium;
      usedCodes = data.usedCodes||usedCodes;
      pelangganList = data.pelangganList||pelangganList;
      karyawanList = data.karyawanList||karyawanList;
      saveAllLocal();
      alert('Data v2 berhasil direstore!');
      renderHome(); renderLayanan(); renderListAdmin(); updatePremiumBadge();
      renderListPelanggan(); renderListKaryawan();
    }catch(err){alert('File tidak valid');}
  };
  r.readAsText(f);
}
function migrateFromOld(){
  if(!confirm('Proses ini akan menyalin data dari versi lama (localStorage) ke versi baru v2 tanpa menghapus data lama. Lanjutkan?')) return;
  try{
    const t = JSON.parse(localStorage.getItem('transaksiKasir') || '[]');
    const lu = JSON.parse(localStorage.getItem('layananUtamaKasir') || '[]');
    const le = JSON.parse(localStorage.getItem('layananEkspresKasir') || '[]');
    const lt = JSON.parse(localStorage.getItem('layananTambahanKasir') || '[]');
    const ud = JSON.parse(localStorage.getItem('usahaDataKasir') || '{}');
    const pr = localStorage.getItem('premiumKasir') === 'true';
    if(t && t.length){ transaksi = t; }
    if(lu && lu.length) layananUtama = lu;
    if(le && le.length) layananEkspres = le;
    if(lt && lt.length) layananTambahan = lt;
    if(pr){ if(confirm('Terdeteksi Premium pada versi lama. Aktifkan premium pada v2 juga?')) premium = true; }
    if(ud && Object.keys(ud).length){
      if(!usahaData || usahaData.nama==='Kasir Laundry'){ usahaData = ud; }
      else if(confirm('Versi lama punya data usaha -- timpa data usaha v2?')) usahaData = ud;
    }
    saveAllLocal();
    renderHome(); renderLayanan(); renderListAdmin(); updatePremiumBadge();
    alert('Data berhasil diimport ke v2');
  }catch(err){alert('Gagal import: '+err.message)}
}

/* --- ADMIN LOGIN --- */
function loginAdminV2(){
  const p=document.getElementById('adminPassV2').value;
  if(p===adminPass){
    alert('Login berhasil');
    document.getElementById('adminPassV2').value='';
    showPage('layananAdmin');
  } else alert('Password salah');
}

/* --- FORMAT --- */
function formatRupiah(x){ if(x===0) return '0'; if(!x && x!==0) return '0'; return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g,'.'); }

/* --- RIWAYAT ACTION --- */
function recalcTotal(trx){
  let total = (trx.hargaUtama||0) * (trx.berat||0);
  (trx.tambahan||[]).forEach(it=> total += (it.harga||0) * (it.qty||0));
  trx.total = total;
  return total;
}
function hapusTransaksi(id){
  if(!confirm('Hapus transaksi ini?')) return;
  transaksi = transaksi.filter(t=>t.id!==id);
  saveAllLocal();
  renderHome(document.getElementById('search')?.value||'');
  if(document.getElementById('page_layanan').style.display==='block') renderRiwayatOnLayanan();
  alert('Riwayat dihapus.');
}
function decrementTambahan(trxId, idx){
  const trx = transaksi.find(t=>t.id===trxId);
  if(!trx || !trx.tambahan || !trx.tambahan[idx]) return;
  const item = trx.tambahan[idx];
  if(item.qty>1){ item.qty -= 1; } else { trx.tambahan.splice(idx,1); }
  recalcTotal(trx);
  saveAllLocal();
  renderHome(document.getElementById('search')?.value||'');
  renderRiwayatOnLayanan();
}
function decrementBerat(trxId){
  const trx = transaksi.find(t=>t.id===trxId);
  if(!trx) return;
  if((trx.berat||0) <= 1) { alert('Berat minimal 1 kg'); return; }
  trx.berat -= 1;
  recalcTotal(trx);
  saveAllLocal();
  renderHome(document.getElementById('search')?.value||'');
  renderRiwayatOnLayanan();
}

/* --- WHATSAPP STRUK --- */
function formatPhoneForWA(nohp){
  let digits = (nohp||'').toString().replace(/[^\d]/g,'');
  if(!digits) return '';
  if(digits.startsWith('0')) return '62'+digits.slice(1);
  if(digits.startsWith('62')) return digits;
  if(digits.startsWith('8')) return '62'+digits;
  return digits;
}
function buildReceiptText(trx, kePemilik=false){
  let usaha = usahaData?.nama ? `‚Äî ${usahaData.nama} ‚Äî` : '‚Äî Kasir Laundry ‚Äî';
  let header = kePemilik ? `*Laporan Transaksi Laundry*` : `Halo ${trx.nama}, berikut struk transaksi laundry Anda`;
  let idLine = `ID: #${trx.id}`;
  let tglLine = `Tanggal: ${trx.tglMasuk||'-'}${trx.tglSelesai? ' ‚Üí '+trx.tglSelesai : ''}`;
  let layananLine = `Layanan: ${trx.layanan} (${trx.kategori})`;
  let utamaLine = `Berat: ${trx.berat} kg √ó Rp${formatRupiah(trx.hargaUtama||0)} = Rp${formatRupiah((trx.hargaUtama||0)*(trx.berat||0))}`;
  let tambahan = '';
  if(trx.tambahan && trx.tambahan.length){
    tambahan = '\nTambahan:\n' + trx.tambahan.map(x=>`- ${x.nama} √ó ${x.qty} √ó Rp${formatRupiah(x.harga||0)} = Rp${formatRupiah((x.harga||0)*(x.qty||0))}`).join('\n');
  }
  let totalLine = `*Total: Rp${formatRupiah(trx.total||0)}*`;
  let pelangganLine = kePemilik ? `Pelanggan: ${trx.nama} (${trx.nohp})\nAlamat: ${trx.alamat||'-'}` : '';
  let karyawanLine = (trx.karyawan && kePemilik) ? `Karyawan: ${trx.karyawan}` : '';
  let usahaLine = kePemilik ? `Usaha: ${usaha}` : '';
  let footer = kePemilik ? `\n` : `\nTerima kasih üôè`;
  let lines = [header,pelangganLine,karyawanLine,idLine,tglLine,layananLine,utamaLine,tambahan,totalLine,usahaLine,footer];
  return lines.filter(Boolean).join('\n');
}
function kirimWAme(id,kePemilik){
  const trx = transaksi.find(t=>t.id===id);
  if(!trx){ alert('Transaksi tidak ditemukan'); return; }
  let text = buildReceiptText(trx,kePemilik);
  let phone = (!kePemilik) ? formatPhoneForWA(trx.nohp) : (usahaData.nohp||'');
  if(!phone) return alert(kePemilik?'No HP pemilik belum diisi di menu Premium & Usaha':'Nomor HP tidak valid');
  const url = 'https://wa.me/'+phone+'?text='+encodeURIComponent(text);
  const win = window.open(url, '_blank');
  if(!win){ location.href = url; }
}

/* --- DEVICE ID --- */
function deviceId(){ return btoa(navigator.userAgent + '|' + screen.width + 'x' + screen.height + '|' + (localStorage.getItem('device_fingerprint')||'')); }
function setDeviceFingerprint(){ if(!localStorage.getItem('device_fingerprint')){ localStorage.setItem('device_fingerprint', Math.random().toString(36).slice(2,10)); } }
</script>


</body></html>
